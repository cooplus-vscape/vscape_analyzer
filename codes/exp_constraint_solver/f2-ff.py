#coding:utf-8
mytargetdict={'SkBaseDevice::flush': 3789,
 'SkBaseDevice::imageInfo': 21117,
 'SkBaseDevice::onAccessPixels': 6934,
 'SkBaseDevice::onAttachToCanvas': 1614,
 'SkBaseDevice::onCreateDevice': 2,
 'SkBaseDevice::onDetachFromCanvas': 930,
 'SkBlitter::blitAntiH': 846568,
 'SkBlitter::blitAntiRect': 60,
 'SkBlitter::blitH': 213412,
 'SkBlitter::blitMask': 6019,
 'SkBlitter::blitRect': 3247,
 'SkBlitter::blitV': 4567,
 'SkCanvas::didRestore': 2625,
 'SkCanvas::didSetMatrix': 6365,
 'SkCanvas::getSaveLayerStrategy': 2,
 'SkCanvas::onClipPath': 10,
 'SkCanvas::onClipRect': 2604,
 'SkCanvas::onDrawBitmap': 1483,
 'SkCanvas::onDrawBitmapRect': 446,
 'SkCanvas::onDrawPaint': 1406,
 'SkCanvas::onDrawPath': 1042,
 'SkCanvas::onDrawPoints': 2,
 'SkCanvas::onDrawPosText': 972,
 'SkCanvas::onDrawRect': 1716,
 'SkCanvas::willSave': 2642,
 'SkPathEffect::asPoints': 2,
 'SkShader::Context::asAShadeProc': 211,
 'SkShader::Context::getFlags': 1675,
 'SkShader::onContextSize': 396,
 'SkShader::onCreateContext': 395,
 'SkSpriteBlitter::setup': 1581,
 'SkXfermode::asMode': 5001,
 'SkXfermode::supportsCoverageAsAlpha': 1,
 'gfxTextContextPaint::GetFillOpacity': 1530,
 'gfxTextContextPaint::GetStrokeOpacity': 446,
 'icu_56::FieldPositionHandler::addAttribute': 72,
 'icu_56::NumberFormat::format': 68,
 'js::BaseProxyHandler::setPrototype': 4,
 'js::GenericPrinter::vprintf': 156,
 'js::jit::MDefinition::canConsumeFloat32': 8,
 'js::wasm::Metadata::serializedSize': 1,
 'mozilla::AbstractMediaDecoder::CanonicalDurationOrNull': 1092,
 'mozilla::AbstractMediaDecoder::CanonicalExplicitDuration': 1092,
 'mozilla::AbstractMediaDecoder::DataArrivedEvent': 1092,
 'mozilla::AbstractMediaDecoder::GetCrashHelper': 547,
 'mozilla::AudioNodeEngine::IsActive': 380,
 'mozilla::AudioNodeEngine::ProcessBlock': 14141,
 'mozilla::AudioNodeEngine::ProduceBlockBeforeInput': 316,
 'mozilla::AudioNodeEngine::RecvTimelineEvent': 37,
 'mozilla::AudioNodeEngine::SetBuffer': 526,
 'mozilla::AudioNodeEngine::SetDoubleParameter': 30,
 'mozilla::AudioNodeEngine::SetInt32Parameter': 2074,
 'mozilla::AudioNodeEngine::SetStreamTimeParameter': 31,
 'mozilla::AudioNodeEngine::SetThreeDPointParameter': 49,
 'mozilla::CounterStyle::CallFallbackStyle': 1440,
 'mozilla::DOMMediaStream::GetCameraStream': 228,
 'mozilla::DirectMediaStreamTrackListener::NotifyDirectListenerInstalled': 1,
 'mozilla::DirectMediaStreamTrackListener::NotifyDirectListenerUninstalled': 1,
 'mozilla::DirectMediaStreamTrackListener::NotifyRealtimeTrackData': 1,
 'mozilla::EditTransactionBase::Release': 58,
 'mozilla::EditorBase::AddRef': 434,
 'mozilla::EditorBase::DeleteSelection': 2,
 'mozilla::EditorBase::Release': 434,
 'mozilla::JsepCodecDescription::AddParametersToMSection': 20,
 'mozilla::JsepSession::GetLastError': 78,
 'mozilla::MediaDataDecoder::IsHardwareAccelerated': 610,
 'mozilla::MediaDataDemuxer::GetCrypto': 536,
 'mozilla::MediaDataDemuxer::NotifyDataArrived': 334,
 'mozilla::MediaDecoder::GetBuffered': 1720,
 'mozilla::MediaDecoder::Shutdown': 214,
 'mozilla::MediaDecoderReader::AsyncReadMetadata': 2,
 'mozilla::MediaDecoderReader::ForceZeroStartTime': 545,
 'mozilla::MediaDecoderReader::GetBuffered': 1205,
 'mozilla::MediaDecoderReader::InitInternal': 547,
 'mozilla::MediaDecoderReader::ReleaseMediaResources': 216,
 'mozilla::MediaDecoderReader::RequestAudioData': 202,
 'mozilla::MediaDecoderReader::Shutdown': 2,
 'mozilla::MediaDecoderReader::VideoIsHardwareAccelerated': 1321,
 'mozilla::MediaResource::CanClone': 9,
 'mozilla::MediaResource::IsExpectingMoreData': 729,
 'mozilla::MediaResource::IsLiveStream': 5,
 'mozilla::MediaResource::SetLoadInBackground': 333,
 'mozilla::MediaResourceCallback::NotifyDataArrived': 1,
 'mozilla::MediaStream::AddDirectTrackListenerImpl': 2,
 'mozilla::MediaStream::ApplyTrackDisabling': 9285,
 'mozilla::MediaStream::DestroyImpl': 20,
 'mozilla::MediaStream::RemoveDirectTrackListenerImpl': 2,
 'mozilla::MediaStreamListener::NotifyBlockingChanged': 1361,
 'mozilla::MediaStreamListener::NotifyEvent': 11,
 'mozilla::MediaStreamListener::NotifyHasCurrentData': 49,
 'mozilla::MediaStreamListener::NotifyOutput': 9325,
 'mozilla::MediaStreamListener::NotifyPull': 2150,
 'mozilla::MediaStreamListener::NotifyQueuedAudioData': 6574,
 'mozilla::MediaStreamListener::NotifyQueuedTrackChanges': 6338,
 'mozilla::MediaStreamTrackListener::NotifyEnded': 3,
 'mozilla::MediaStreamTrackListener::NotifyQueuedChanges': 5081,
 'mozilla::MediaTrackDemuxer::GetNextRandomAccessPoint': 631,
 'mozilla::OggCodecState::DecodeHeader': 854,
 'mozilla::OggCodecState::Init': 278,
 'mozilla::OggCodecState::PacketDuration': 3540,
 'mozilla::OggCodecState::Reset': 852,
 'mozilla::OggCodecState::Time': 5250,
 'mozilla::ProcessedMediaStream::AddInput': 273,
 'mozilla::ProcessedMediaStream::RemoveInput': 14,
 'mozilla::dom::Animation::Pause': 1,
 'mozilla::dom::Animation::Play': 21,
 'mozilla::dom::BlobImpl::MayBeClonedToOtherThreads': 14,
 'mozilla::dom::CanvasRenderingContextHelper::CreateContext': 7214,
 'mozilla::dom::Event::StopImmediatePropagation': 2,
 'mozilla::dom::PBlobChild::ActorDestroy': 1,
 'mozilla::dom::PBroadcastChannelChild::ActorDestroy': 1,
 'mozilla::dom::PMessagePortChild::ActorDestroy': 2,
 'mozilla::dom::PerformanceEntry::Duration': 16,
 'mozilla::dom::StructuredCloneHolderBase::CustomReadTransferHandler': 8,
 'mozilla::dom::StructuredCloneHolderBase::CustomWriteTransferHandler': 9,
 'mozilla::dom::UIEvent::InitUIEvent': 95,
 'mozilla::dom::UIEvent::Which': 80,
 'mozilla::dom::WebCryptoTask::Cleanup': 101,
 'mozilla::dom::WebCryptoTask::DoCrypto': 101,
 'mozilla::dom::WebCryptoTask::ReleaseNSSResources': 101,
 'mozilla::dom::WebCryptoTask::Resolve': 101,
 'mozilla::dom::XMLDocument::StartDocumentLoad': 3,
 'mozilla::dom::indexedDB::(anonymous namespace)::TransactionBase::UpdateMetadata': 129392,
 'mozilla::dom::indexedDB::(anonymous namespace)::TransactionDatabaseOperationBase::Cleanup': 431368,
 'mozilla::dom::indexedDB::PBackgroundIDBDatabaseChild::RecvPBackgroundIDBVersionChangeTransactionConstructor': 43160,
 'mozilla::dom::indexedDB::PBackgroundIDBDatabaseParent::RecvPBackgroundIDBTransactionConstructor': 86251,
 'mozilla::gfx::DrawTarget::Draw3DTransformedSurface': 238,
 'mozilla::gfx::FilterNode::SetAttribute': 3982,
 'mozilla::gfx::FilterNode::SetInput': 2511,
 'mozilla::layers::CanvasClient::Updated': 1183,
 'mozilla::layers::CompositableHost::RemoveTextureHost': 5743,
 'mozilla::layers::CompositableHost::SetImageContainer': 323,
 'mozilla::layers::Image::GetPictureRect': 9655,
 'mozilla::layers::Image::IsValid': 12980,
 'mozilla::layers::LayerManager::AreComponentAlphaLayersEnabled': 616,
 'mozilla::layers::LayerManager::CanUseCanvasLayerForSize': 4046,
 'mozilla::layers::LayerManager::Composite': 290,
 'mozilla::layers::PersistentBufferProvider::GetTextureClient': 1184,
 'mozilla::layers::TextureData::BorrowMappedYCbCrData': 2042,
 'mozilla::layers::TextureHost::HasIntermediateBuffer': 6312,
 'mozilla::layers::TextureSource::AsDataTextureSource': 342,
 'mozilla::layers::TextureSourceBasic::SetBufferTextureHost': 171,
 'mozilla::media::MediaSink::Redraw': 337,
 'mozilla::media::MediaSink::SetPlaybackRate': 4,
 'mozilla::media::MediaSink::Shutdown': 440,
 'mozilla::net::HttpBaseChannel::Release': 167,
 'mozilla::net::nsAHttpTransaction::QueryNullTransaction': 7946,
 'mozilla::plugins::PBrowserStreamChild::Recv__delete__': 33,
 'mozilla::plugins::PPluginModuleChild::EnteredCxxStack': 758,
 'mozilla::plugins::PPluginModuleChild::ExitedCxxStack': 757,
 'nsBaseChannel::Pending': 2541,
 'nsBaseContentList::AddRef': 273,
 'nsDOMCSSDeclaration::IndexedGetter': 1,
 'nsDocument::Init': 3,
 'nsFileOutputStream::Init': 1,
 'nsFrame::Init': 300,
 'nsICSSDeclaration::GetPropertyCSSValue': 4,
 'nsICanvasRenderingContextInternal::GetPresShell': 28847,
 'nsICanvasRenderingContextInternal::SetContextOptions': 7290,
 'nsICanvasRenderingContextInternal::ShouldForceInactiveLayer': 4046,
 'nsMathMLContainerFrame::FixInterFrameSpacing': 17897,
 'nsMathMLContainerFrame::GetIntrinsicISizeMetrics': 28523,
 'nsMathMLContainerFrame::Place': 40148,
 'nsPluginNativeWindow::CallSetWindow': 83,
 'nsSMILAnimationFunction::GetValues': 1109,
 'nsSMILTimeContainer::Pause': 4,
 'nsSMILTimeContainer::RemoveChild': 5,
 'nsSVGContainerFrame::GetCanvasTM': 406,
 'nsSVGElement::SetAnimateMotionTransform': 363,
 'nsSVGFE::GetSourceImageNames': 1340,
 'nsSVGIDRenderingObserver::DoUpdate': 913,
 'nsSVGPathGeometryElement::GetMarkPoints': 63,
 'nsScriptErrorBase::ToString': 29,
 'nsTextFrame::DrawPathCallbacks::NotifyBeforeText': 23,
 'nsXMLContentSerializer::AfterElementStart': 2113,
 'nsXMLContentSerializer::AppendAndTranslateEntities': 5137,
 'nsXMLContentSerializer::CheckElementEnd': 2113,
 'nsXMLContentSerializer::SerializeAttributes': 2113,
 'ots::OTSContext::Message': 7,
 'soundtouch::FIRFilter::evaluateFilterStereo': 22,
 'soundtouch::FIRFilter::setCoefficients': 2,
 'soundtouch::TransposerBase::setRate': 1,
 'stagefright::DataSource::flags': 28}

from sys import path
path.append("../")
import json
from DBatom import *
from globalconfig import *
from pprint import pprint

clcl, clclient = getdbhandler(COOPPLUSDB, CLASSLAYOUT)
vccl, vcclient = getdbhandler(COOPPLUSDB,VCALLSITE+"_4")

def getclasssize(classname):
    fi = {
        "classname":classname,
    }
    doc = clcl.find_one(fi)
    if doc.__contains__("size"):
        return doc["size"]
    else:
        return None

v2cl, v2client = getdbhandler(COOPPLUSDB, VMETHOD_TO_AN+"_3")


mypip = [
    {"$group": {
        "_id": "$_id"
    }}
]

re = vccl.aggregate(mypip, allowDiskUse=True, maxTimeMS=9000000)
contentlist_1 = []
contentlist = []
for i in re:
    contentlist_1.append(i["_id"])

for c in contentlist_1:
    fi = {
        "_id": c,
    }
    i = vccl.find_one(fi)

# for i in re:
    # print i
    uvcname = i["interface_classname"]+i["rawmethod"]
    if uvcname in mytargetdict:
        contentlist.append(i["vmethodid"])
print (len(contentlist))

allnum=0
loglist =[]
mycount=0
pair_count = 0
pair_count_in_uvc = 0
uvc_count = 0


uvc_list = []


for c in contentlist:
    pair_dict= {}
    qualified_base = []
    qualified_counterfeit = []
    pair_count_in_uvc = 0

    mycount += 1

    # print mycount
    fi = {
        "_id": c,
    }
    doc = v2cl.find_one(fi)
    obj = doc["class"]
    for item in obj:
        size = getclasssize(item)
        if size:
            if size >=128:
                #HIT
                qualified_base.append((item,size))
    # print qualified_base
    # print obj
    for item,size in qualified_base:
        # print("\n"*8)
        # pprint (obj)
        # print obj[item]
        if type(obj[item]) == type([]):
            if len(obj[item])>1:
                for mv in obj[item][1]:
                    if mv["accesstype"].find("W")!=-1: # Write COND
                        offset = mv["accessoffset"]
                        if int(offset)%8>1:
                            vn = mv["variablename"].lower()
                            if vn.find("ptr")==-1: # NonPtr COND
                                qualified_counterfeit.append((item,offset))
    
    for item,size in qualified_base:
        pair_dict[item]=[]
        for counterfeit_class,offset in qualified_counterfeit:
            if offset >=size:
                if counterfeit_class not in pair_dict[item]:
                    pair_dict[item].append(counterfeit_class)
                    pair_count=pair_count+1
                    pair_count_in_uvc=pair_count_in_uvc+1
                    # print("hit one")
    # json.dumps()
    if pair_count_in_uvc >0:
        uvc_id =doc["vcallsiteid"]
        uvc_count = uvc_count+1
        uvc_list.append(uvc_id)

    print("\n")
    
    print("uvc_count:%d / %d"%(uvc_count,mycount))
    print("pair_count:%d"%pair_count)
    # if uvc_count == 3:
    #     break

for id in uvc_list:
    # print id
    fi = {
        "_id": id,
    }
    doc = vccl.find_one(fi)
    re = doc["interface_classname"]+doc ["rawmethod"]
    print (re)
    
    
    