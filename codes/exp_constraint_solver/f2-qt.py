#coding:utf-8
mytargetdict={
    'QAbstractAnimation::updateState': 813,
 'QAbstractAudioOutput::setVolume': 1,
 'QAbstractAudioOutput::volume': 1,
 'QAbstractFileEngine::beginEntryList': 2,
 'QAbstractFileEngine::fileTime': 477,
 'QAbstractFileEngine::handle': 6,
 'QAbstractFileEngine::isRelativePath': 14,
 'QAbstractFileEngine::remove': 27,
 'QAbstractFileEngine::setFileName': 2,
 'QAbstractFileEngineIterator::currentFileInfo': 23,
 'QAbstractItemDelegate::setModelData': 2,
 'QAbstractItemModel::buddy': 51,
 'QAbstractItemModel::canFetchMore': 568,
 'QAbstractItemModel::fetchMore': 1,
 'QAbstractItemModel::flags': 31008,
 'QAbstractItemModel::hasChildren': 11163,
 'QAbstractItemModel::headerData': 8473,
 'QAbstractItemModel::removeRows': 17,
 'QAbstractItemModel::roleNames': 819,
 'QAbstractItemModel::setData': 214,
 'QAbstractItemModel::sibling': 188,
 'QAbstractItemModel::sort': 5,
 'QAbstractItemView::currentChanged': 473,
 'QAbstractItemView::dataChanged': 640,
 'QAbstractItemView::rowsAboutToBeRemoved': 16,
 'QAbstractItemView::rowsInserted': 242,
 'QAbstractItemView::setModel': 219,
 'QAbstractItemView::setSelectionModel': 396,
 'QAbstractItemView::updateGeometries': 596,
 'QAbstractItemView::viewOptions': 1011,
 'QAbstractItemViewPrivate::_q_modelDestroyed': 103,
 'QAbstractScrollArea::event': 4,
 'QAbstractScrollArea::viewportEvent': 7644,
 'QAbstractScrollAreaPrivate::scrollBarPolicyChanged': 482,
 'QAbstractSliderPrivate::bound': 839,
 'QAbstractSpinBoxPrivate::emitSignals': 39,
 'QAbstractTransitionPrivate::callOnTransition': 20,
 'QAnimationDriver::advance': 2025,
 'QAnimationDriver::elapsed': 2033,
 'QAnimationDriver::start': 12,
 'QAnimationGroupPrivate::animationInsertedAt': 121,
 'QBearerEngineImpl::startTime': 1,
 'QCommonListViewBase::horizontalOffset': 327,
 'QCommonListViewBase::horizontalScrollToValue': 1,
 'QCommonListViewBase::scrollContentsBy': 1,
 'QCommonListViewBase::updateHorizontalScrollBar': 16,
 'QCommonListViewBase::updateVerticalScrollBar': 16,
 'QCommonListViewBase::verticalOffset': 327,
 'QCommonStyle::drawPrimitive': 2,
 'QCommonStyle::metaObject': 8,
 'QCommonStyle::pixelMetric': 2,
 'QCommonStyle::styleHint': 215,
 'QCommonStyle::subElementRect': 971,
 'QCompleter::splitPath': 111,
 'QCoreApplication::compressEvent': 5351,
 'QDBusAbstractInterface::metaObject': 365,
 'QDialogPrivate::canBeNativeDialog': 36,
 'QEasingCurveFunction::value': 9195,
 'QFontEngine::addGlyphsToPath': 2,
 'QFontEngine::boundingBox': 87179,
 'QFontEngine::doKerning': 853,
 'QFontEngine::expectsGammaCorrectedBlending': 50681,
 'QFontEngine::faceId': 198,
 'QFontEngine::getSfntTableData': 402,
 'QFontEngine::hasInternalCaching': 15242,
 'QFontEngine::lineThickness': 257,
 'QFontEngine::lockedAlphaMapForGlyph': 55873,
 'QFontEngine::recalcAdvances': 721988,
 'QFontEngine::supportsSubPixelPositions': 113125,
 'QFontEngine::underlinePosition': 253,
 'QFrame::sizeHint': 12,
 'QGraphicsItem::itemChange': 15391,
 'QGraphicsItem::shape': 15924,
 'QGraphicsItemPrivate::resolveFont': 1133,
 'QGraphicsItemPrivate::resolvePalette': 1133,
 'QGraphicsLayoutItem::setGeometry': 47,
 'QGraphicsScene::drawBackground': 2105,
 'QGraphicsScene::metaObject': 54,
 'QGraphicsSceneIndex::clear': 1,
 'QGraphicsWidget::paint': 2341,
 'QGraphicsWidget::resizeEvent': 258,
 'QIODevice::metaObject': 1,
 'QIODevice::open': 574,
 'QIODevicePrivate::peek': 1893,
 'QIconEngine::actualSize': 2839,
 'QIconEngine::pixmap': 217,
 'QIconEngine::virtual_hook': 7015,
 'QImageIOHandler::setOption': 610,
 'QLayout::expandingDirections': 817,
 'QLayout::invalidate': 6713,
 'QLayout::maximumSize': 275,
 'QLayout::minimumSize': 1291,
 'QLayout::setGeometry': 1316,
 'QLayoutItem::heightForWidth': 330,
 'QLayoutItem::invalidate': 5542,
 'QMetaCallEvent::placeMetaCall': 18646,
 'QMimeProviderBase::loadIcon': 2,
 'QNetworkAccessManager::createRequest': 37,
 'QObject::disconnectNotify': 7080,
 'QObject::eventFilter': 16777,
 'QObject::qt_metacall': 27265,
 'QObject::qt_metacast': 8213,
 'QObject::timerEvent': 8334,
 'QPaintDevice::initPainter': 14661,
 'QPaintDevice::metric': 677509,
 'QPaintDevice::redirected': 50294,
 'QPaintEngine::drawTextItem': 7622,
 'QPaintEngineEx::drawEllipse': 78769,
 'QPaintEngineEx::drawImage': 37549,
 'QPaintEngineEx::drawPixmap': 34481,
 'QPaintEngineEx::drawPoints': 413,
 'QPaintEngineEx::drawPolygon': 1928,
 'QPaintEngineEx::drawRects': 9325,
 'QPaintEngineEx::drawTiledPixmap': 306,
 'QPaintEngineEx::fillRect': 26628,
 'QPaintEngineEx::setState': 206811,
 'QPaintEngineEx::stroke': 51027,
 'QPaintEnginePrivate::systemStateChanged': 1761,
 'QPlatformAccessibility::notifyAccessibilityUpdate': 6202,
 'QPlatformBackingStore::beginPaint': 5741,
 'QPlatformBackingStore::endPaint': 5629,
 'QPlatformBackingStore::scroll': 6,
 'QPlatformClipboard::mimeData': 1,
 'QPlatformCursor::pos': 156,
 'QPlatformFontDatabase::fontEngine': 224,
 'QPlatformFontDatabase::populateFontDatabase': 126,
 'QPlatformInputContext::commit': 85,
 'QPlatformInputContext::isValid': 161,
 'QPlatformInputContext::setFocusObject': 478,
 'QPlatformInputContext::update': 362,
 'QPlatformIntegration::accessibility': 14314,
 'QPlatformIntegration::clipboard': 1,
 'QPlatformIntegration::drag': 4,
 'QPlatformIntegration::fontDatabase': 15488,
 'QPlatformIntegration::hasCapability': 1533,
 'QPlatformIntegration::initialize': 161,
 'QPlatformIntegration::inputContext': 1280,
 'QPlatformIntegration::nativeInterface': 1126,
 'QPlatformIntegration::services': 383,
 'QPlatformPixmap::copy': 323,
 'QPlatformPixmap::toImage': 474,
 'QPlatformPixmap::transformed': 126,
 'QPlatformScreen::availableGeometry': 322,
 'QPlatformScreen::cursor': 454,
 'QPlatformScreen::devicePixelRatio': 221,
 'QPlatformScreen::grabWindow': 1,
 'QPlatformScreen::logicalDpi': 322,
 'QPlatformScreen::orientation': 161,
 'QPlatformScreen::refreshRate': 161,
 'QPlatformScreen::virtualSiblings': 884,
 'QPlatformTheme::themeHint': 2668,
 'QPlatformWindow::devicePixelRatio': 8299,
 'QPlatformWindow::format': 6,
 'QPlatformWindow::frameMargins': 880,
 'QPlatformWindow::geometry': 7703,
 'QPlatformWindow::isActive': 24965,
 'QPlatformWindow::isAlertState': 217,
 'QPlatformWindow::isEmbedded': 144,
 'QPlatformWindow::isExposed': 222,
 'QPlatformWindow::setGeometry': 128,
 'QPlatformWindow::setMask': 1,
 'QPlatformWindow::setVisible': 156,
 'QPlatformWindow::setWindowFlags': 6,
 'QPlatformWindow::setWindowIcon': 268,
 'QPlatformWindow::setWindowTitle': 503,
 'QPlatformWindow::winId': 268,
 'QPlatformWindow::windowEvent': 851,
 'QQmlJS::AST::Visitor::visit': 442,
 'QQmlTypeLoader::Blob::stringAt': 34,
 'QRemoteObjectReplica::metaObject': 5,
 'QSignalTransition::onTransition': 8,
 'QSqlQueryModel::data': 6,
 'QStyle::polish': 5330,
 'QStyle::unpolish': 84,
 'QTextEditPrivate::resolveUrl': 1,
 'QTextFramePrivate::fragmentAdded': 94,
 'QTextFramePrivate::fragmentRemoved': 3,
 'QThread::metaObject': 313,
 'QThread::run': 330,
 'QTimeZonePrivate::standardTimeOffset': 10,
 'QV4::Compiler::Codegen::beginFunctionBodyHook': 5,
 'QVariantAnimation::updateCurrentValue': 25292,
 'QWidget::actionEvent': 819,
 'QWidget::changeEvent': 9307,
 'QWidget::focusInEvent': 338,
 'QWidget::focusOutEvent': 110,
 'QWidget::hideEvent': 72,
 'QWidget::metaObject': 25004,
 'QWidget::minimumSizeHint': 4746,
 'QWidget::moveEvent': 3624,
 'QWidget::paintEvent': 8936,
 'QWidget::resizeEvent': 3074,
 'QWidget::setVisible': 7138,
 'QWidget::showEvent': 2682,
 'QWidget::sizeHint': 6528,
 'QWidgetItem::maximumSize': 4260,
 'QWidgetItem::sizeHint': 631,
 'QWidgetPrivate::aboutToDestroy': 147,
 'QWidgetPrivate::beginBackingStorePainting': 6264,
 'QWidgetPrivate::endBackingStorePainting': 6249,
 'QWidgetPrivate::resizeViewportFramebuffer': 241,
 'QWidgetPrivate::setWindowFlags': 18,
 'QWidgetTextControl::blockBoundingRect': 406,
 'QWindow::exposeEvent': 1,
 'QWindow::resizeEvent': 1,
 'QWindowsStyle::subElementRect': 1,
 'QWizardPage::initializePage': 2,
 'QWizardPage::nextId': 4,
 'QXcbBackingStore::recreateImage': 253,
 'QXcbBackingStore::render': 5704,
 'QXcbGlIntegration::handleXcbEvent': 152,
 'QXcbWindow::create': 270,
 'QXcbWindow::createVisual': 270,
 'QXcbWindow::resolveFormat': 270,
 'QXcbWindowEventListener::handleClientMessageEvent': 741,
 'QXcbWindowEventListener::handleConfigureNotifyEvent': 222,
 'QXcbWindowEventListener::handleExposeEvent': 78,
 'QXcbWindowEventListener::handleMapNotifyEvent': 144,
 'QXcbWindowEventListener::handlePropertyNotifyEvent': 6837,
 'QtGraphicsAnchorLayout::AnchorData::updateChildrenSizes': 44}

from sys import path
path.append("../")

from DBatom import *
from globalconfig import *
from pprint import pprint
COOPPLUSDB = 'QT-1'

clcl, clclient = getdbhandler(COOPPLUSDB, CLASSLAYOUT)
vccl, vcclient = getdbhandler(COOPPLUSDB,VCALLSITE+"_4")

def getclasssize(classname):
    fi = {
        "classname":classname,
    }
    doc = clcl.find_one(fi)
    if doc.__contains__("size"):
        return doc["size"]
    else:
        return None

v2cl, v2client = getdbhandler(COOPPLUSDB, VMETHOD_TO_AN+"_3")


mypip = [
    {"$group": {
        "_id": "$_id"
    }}
]

re = vccl.aggregate(mypip, allowDiskUse=True, maxTimeMS=9000000)
contentlist_1 = []
contentlist = []
for i in re:
    contentlist_1.append(i["_id"])

for c in contentlist_1:
    fi = {
        "_id": c,
    }
    i = vccl.find_one(fi)

# for i in re:
    # print i
    uvcname = i["interface_classname"]+i["rawmethod"]
    if uvcname in mytargetdict:
        contentlist.append(i["vmethodid"])
print (len(contentlist))

allnum=0
loglist =[]
mycount=0
pair_count = 0
pair_count_in_uvc = 0
uvc_count = 0

uvc_list = []


for c in contentlist:
    pair_dict= {}
    qualified_base = []
    qualified_counterfeit = []
    pair_count_in_uvc = 0

    mycount += 1

    # print mycount
    fi = {
        "_id": c,
    }
    doc = v2cl.find_one(fi)
    obj = doc["class"]
    for item in obj:
        size = getclasssize(item)
        if size:
            if size >=128 or True:
                qualified_base.append((item,size))
    # print qualified_base
    # print obj
    for item,size in qualified_base:
        # print("\n"*8)
        # pprint (obj)
        # print obj[item]
        if type(obj[item]) == type([]):
            if len(obj[item])>1:
                for mv in obj[item][1]:
                    if mv["accesstype"].find("W")!=-1: 
                        offset = mv["accessoffset"]
                        if int(offset)%8>1:
                            vn = mv["variablename"].lower()
                            if vn.find("ptr")==-1: 
                                qualified_counterfeit.append((item,offset))
    
    for item,size in qualified_base:
        pair_dict[item]=[]
        for counterfeit_class,offset in qualified_counterfeit:
            if offset >=size:
                if counterfeit_class not in pair_dict[item]:
                    pair_dict[item].append(counterfeit_class)
                    pair_count=pair_count+1
                    pair_count_in_uvc=pair_count_in_uvc+1
                    # print("hit one")
    
    if pair_count_in_uvc >0:
        uvc_count = uvc_count+1
        uvc_id =doc["vcallsiteid"]
        uvc_list.append(uvc_id)

    print("\n")
    
    print("uvc_count:%d / %d"%(uvc_count,mycount))
    print("pair_count:%d"%pair_count)
    # if uvc_count == 2:
    #     break
    
for id in uvc_list:
    # print id
    fi = {
        "_id": id,
    }
    doc = vccl.find_one(fi)
    re = doc["interface_classname"]+doc ["rawmethod"]
    print (re)
    
    